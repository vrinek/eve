<p class="tip">
	Add new lines as you see fit to contain all items of the contract.<br>
	Results and total are calculated in real time.<br>
	The item names are not used in the calculations and are there only for your convenience.
</p>

<ul id="calculations">
	<li id="add-new-line">
		<span class="label">Item</span>
		<span class="price">ISK</span>
		<span class="quantity">Quantity</span>
		<a href="#" onclick="addNewLine(); return false;">add new line</a>
	</li>
	<li id="total">
		<span class="label">TOTAL</span>
		<span class="result">0.00</span>
	</li>
</ul>

<script type="text/javascript" charset="utf-8">
	lastLineId = 0;
	total = 0;
	
	addNewLine = function(){
		id = lastLineId + 1;
		liHTML = '<li class="calculation" id="calculation-'+id+'">\
			<span class="result">0.00</span>\
			<input type="text" class="label" value="Item name">\
			<input type="text" value="0.00" class="price" onkeyup="calculateResult('+id+')" onblur="numFor(this, 2)" onfocus="invNumFor(this)">\
			&times;\
			<input type="text" value="0" class="quantity" onkeyup="calculateResult('+id+')" onblur="numFor(this)" onfocus="invNumFor(this)">\
			=\
		</li>'
		
		$('total').insert({
			before: liHTML
		});
		$$('#calculation-'+id+' .label')[0].focus();
		lastLineId = id;
	};
	
	addNewLine();
	
	calculateResult = function(id){
		// recalculate the new result of the changed line
		price = $$('#calculation-'+id+' .price')[0].value.replace(/[^\d\.]/g, '');
		quantity = $$('#calculation-'+id+' .quantity')[0].value.replace(/[^\d\.]/g, '');
		newResult = new Number(price * quantity);
		$$('#calculation-'+id+' .result')[0].innerHTML = number_format(newResult, 2);
		
		// recalculate the total sum from all the lines (less error prone)
		total = 0;
		$$('li.calculation .result').each(function(result){
			total = total + new Number(result.innerHTML.replace(/[^\d\.]/g, ''));
		});
		
		$$('#total .result')[0].innerHTML = number_format(total, 2);
	};
	
	numFor = function(element, decimals){
		element.value = number_format(element.value.replace(/[^\d\.]/g, ''), decimals)
	};
	
	invNumFor = function(element){
		element.value = element.value.replace(/[^\d\.]/g, '')
	};
</script>
